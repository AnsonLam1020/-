<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>包剪揼遊戲 - 鏡頭手勢版</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js" crossorigin="anonymous"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', 'Microsoft JhengHei', sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #0f0c29 0%, #302b63 50%, #24243e 100%);
            color: #fff;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        header {
            text-align: center;
            margin-bottom: 30px;
            width: 100%;
        }
        
        h1 {
            font-size: 3.5rem;
            margin-bottom: 10px;
            background: linear-gradient(90deg, #00dbde, #fc00ff);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
        }
        
        .subtitle {
            font-size: 1.2rem;
            color: #a1c4fd;
            margin-bottom: 20px;
        }
        
        .game-area {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            width: 100%;
            margin-bottom: 40px;
        }
        
        @media (max-width: 1024px) {
            .game-area {
                grid-template-columns: 1fr;
            }
        }
        
        .camera-section, .game-section {
            background: rgba(255, 255, 255, 0.08);
            border-radius: 20px;
            padding: 25px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(5px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .section-title {
            font-size: 1.8rem;
            margin-bottom: 20px;
            color: #00dbde;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        #camera-container {
            position: relative;
            width: 100%;
            height: 400px;
            border-radius: 15px;
            overflow: hidden;
            background: #000;
            margin-bottom: 20px;
        }
        
        #camera-feed {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transform: scaleX(-1); /* 鏡像反轉 */
        }
        
        #camera-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }
        
        .camera-controls {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 20px;
            flex-wrap: wrap;
        }
        
        .control-btn {
            padding: 12px 24px;
            font-size: 1.1rem;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 10px;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
        }
        
        #start-camera-btn {
            background: linear-gradient(90deg, #00dbde, #0099ff);
            color: white;
        }
        
        #stop-camera-btn {
            background: linear-gradient(90deg, #ff416c, #ff4b2b);
            color: white;
        }
        
        .control-btn:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 25px rgba(0, 0, 0, 0.4);
        }
        
        #start-camera-btn:hover {
            background: linear-gradient(90deg, #00c7cb, #0088dd);
        }
        
        #stop-camera-btn:hover {
            background: linear-gradient(90deg, #e63a5f, #e6392a);
        }
        
        .hand-status {
            display: flex;
            justify-content: space-around;
            margin-top: 20px;
            flex-wrap: wrap;
        }
        
        .hand-info {
            text-align: center;
            padding: 15px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            min-width: 180px;
            margin: 5px;
        }
        
        .hand-label {
            font-size: 1.2rem;
            margin-bottom: 10px;
            color: #fc00ff;
        }
        
        .gesture-icon {
            font-size: 3rem;
            margin-bottom: 10px;
            height: 60px;
        }
        
        .gesture-text {
            font-size: 1.5rem;
            font-weight: bold;
        }
        
        .rock { color: #ff9a9e; }
        .paper { color: #a1c4fd; }
        .scissors { color: #a6ffcb; }
        .unknown { color: #aaa; }
        
        .game-section {
            display: flex;
            flex-direction: column;
        }
        
        .score-board {
            display: flex;
            justify-content: space-around;
            margin-bottom: 30px;
        }
        
        .score-item {
            text-align: center;
            padding: 20px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 15px;
            min-width: 150px;
        }
        
        .score-label {
            font-size: 1.2rem;
            margin-bottom: 10px;
            color: #00dbde;
        }
        
        .score-value {
            font-size: 3rem;
            font-weight: bold;
            color: #fc00ff;
            text-shadow: 0 0 10px rgba(252, 0, 255, 0.5);
        }
        
        .result-area {
            text-align: center;
            padding: 25px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 15px;
            margin-bottom: 30px;
        }
        
        #result-text {
            font-size: 2.5rem;
            margin-bottom: 15px;
            min-height: 70px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .win { color: #a6ffcb; text-shadow: 0 0 10px rgba(166, 255, 203, 0.7); }
        .lose { color: #ff9a9e; text-shadow: 0 0 10px rgba(255, 154, 158, 0.7); }
        .draw { color: #a1c4fd; text-shadow: 0 0 10px rgba(161, 196, 253, 0.7); }
        
        #game-info {
            font-size: 1.2rem;
            color: #00dbde;
            margin-bottom: 10px;
        }
        
        .game-controls {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: auto;
            flex-wrap: wrap;
        }
        
        .action-btn {
            padding: 15px 30px;
            font-size: 1.2rem;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 10px;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
        }
        
        #play-btn {
            background: linear-gradient(90deg, #fc00ff, #00dbde);
            color: white;
        }
        
        #reset-btn {
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .action-btn:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 25px rgba(0, 0, 0, 0.4);
        }
        
        #play-btn:hover {
            background: linear-gradient(90deg, #e600e6, #00c7cb);
        }
        
        #reset-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }
        
        .gesture-guide {
            margin-top: 40px;
            width: 100%;
            background: rgba(255, 255, 255, 0.08);
            padding: 25px;
            border-radius: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(5px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .gesture-guide h3 {
            font-size: 1.8rem;
            margin-bottom: 20px;
            color: #fc00ff;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .gesture-list {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 25px;
        }
        
        .gesture-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            padding: 20px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 15px;
        }
        
        .gesture-demo {
            font-size: 4rem;
            margin-bottom: 15px;
            height: 80px;
        }
        
        .gesture-name {
            font-size: 1.5rem;
            font-weight: bold;
            margin-bottom: 10px;
        }
        
        .gesture-desc {
            font-size: 1rem;
            color: #ccc;
        }
        
        .permission-message {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            padding: 20px;
            z-index: 10;
            border-radius: 15px;
        }
        
        .permission-message h3 {
            color: #00dbde;
            margin-bottom: 20px;
            font-size: 1.8rem;
        }
        
        .permission-message p {
            margin-bottom: 30px;
            color: #ccc;
            max-width: 500px;
            line-height: 1.6;
        }
        
        #camera-error {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            padding: 20px;
            z-index: 10;
            border-radius: 15px;
        }
        
        #camera-error h3 {
            color: #ff416c;
            margin-bottom: 20px;
            font-size: 1.8rem;
        }
        
        #camera-error p {
            margin-bottom: 30px;
            color: #ccc;
            max-width: 500px;
            line-height: 1.6;
        }
        
        footer {
            margin-top: 40px;
            text-align: center;
            color: #00dbde;
            font-size: 1rem;
            padding: 20px;
            width: 100%;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        
        .pulse {
            animation: pulse 0.5s ease infinite;
        }
        
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-10px); }
            75% { transform: translateX(10px); }
        }
        
        .shake {
            animation: shake 0.5s ease;
        }
        
        @keyframes glow {
            0%, 100% { box-shadow: 0 0 10px rgba(0, 219, 222, 0.7); }
            50% { box-shadow: 0 0 25px rgba(0, 219, 222, 1); }
        }
        
        .glow {
            animation: glow 1s ease infinite;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1><i class="fas fa-hand-rock"></i> 包剪揼遊戲 - 鏡頭手勢版 <i class="fas fa-hand-scissors"></i></h1>
            <p class="subtitle">使用鏡頭偵測手勢，與電腦對戰！</p>
        </header>
        
        <div class="game-area">
            <div class="camera-section">
                <h2 class="section-title"><i class="fas fa-video"></i> 鏡頭畫面</h2>
                
                <div id="camera-container">
                    <video id="camera-feed" autoplay playsinline></video>
                    <canvas id="camera-overlay"></canvas>
                    
                    <div id="permission-message" class="permission-message">
                        <h3><i class="fas fa-camera"></i> 需要鏡頭權限</h3>
                        <p>請允許使用鏡頭以偵測手勢。您的影像資料只會在瀏覽器內處理，不會傳送到任何伺服器。</p>
                        <button id="request-permission-btn" class="control-btn">
                            <i class="fas fa-camera"></i> 允許使用鏡頭
                        </button>
                    </div>
                    
                    <div id="camera-error" class="permission-message">
                        <h3><i class="fas fa-exclamation-triangle"></i> 無法存取鏡頭</h3>
                        <p id="error-message">無法存取您的鏡頭裝置。請檢查瀏覽器設定或連接的鏡頭。</p>
                        <button id="retry-camera-btn" class="control-btn">
                            <i class="fas fa-redo"></i> 重試
                        </button>
                    </div>
                </div>
                
                <div class="camera-controls">
                    <button id="start-camera-btn" class="control-btn">
                        <i class="fas fa-play"></i> 開啟鏡頭
                    </button>
                    <button id="stop-camera-btn" class="control-btn">
                        <i class="fas fa-stop"></i> 關閉鏡頭
                    </button>
                </div>
                
                <div class="hand-status">
                    <div class="hand-info">
                        <div class="hand-label">左手</div>
                        <div id="left-hand-icon" class="gesture-icon">
                            <i class="fas fa-question unknown"></i>
                        </div>
                        <div id="left-hand-text" class="gesture-text">未偵測</div>
                    </div>
                    
                    <div class="hand-info">
                        <div class="hand-label">右手</div>
                        <div id="right-hand-icon" class="gesture-icon">
                            <i class="fas fa-question unknown"></i>
                        </div>
                        <div id="right-hand-text" class="gesture-text">未偵測</div>
                    </div>
                </div>
            </div>
            
            <div class="game-section">
                <h2 class="section-title"><i class="fas fa-gamepad"></i> 遊戲狀態</h2>
                
                <div class="score-board">
                    <div class="score-item">
                        <div class="score-label">玩家</div>
                        <div class="score-value" id="player-score">0</div>
                    </div>
                    
                    <div class="score-item">
                        <div class="score-label">電腦</div>
                        <div class="score-value" id="computer-score">0</div>
                    </div>
                </div>
                
                <div class="result-area">
                    <div id="result-text">開啟鏡頭後顯示手勢</div>
                    <div id="game-info">請將手放在鏡頭前，系統會自動偵測手勢</div>
                </div>
                
                <div class="game-controls">
                    <button class="action-btn" id="play-btn">
                        <i class="fas fa-fist-raised"></i> 開始遊戲
                    </button>
                    
                    <button class="action-btn" id="reset-btn">
                        <i class="fas fa-redo"></i> 重新開始
                    </button>
                </div>
            </div>
        </div>
        
        <div class="gesture-guide">
            <h3><i class="fas fa-gesture"></i> 手勢指南</h3>
            <div class="gesture-list">
                <div class="gesture-item">
                    <div class="gesture-demo">
                        <i class="fas fa-hand-rock rock"></i>
                    </div>
                    <div class="gesture-name rock">石頭</div>
                    <div class="gesture-desc">握拳，所有手指收起</div>
                </div>
                
                <div class="gesture-item">
                    <div class="gesture-demo">
                        <i class="fas fa-hand-paper paper"></i>
                    </div>
                    <div class="gesture-name paper">布</div>
                    <div class="gesture-desc">手掌張開，手指伸直</div>
                </div>
                
                <div class="gesture-item">
                    <div class="gesture-demo">
                        <i class="fas fa-hand-scissors scissors"></i>
                    </div>
                    <div class="gesture-name scissors">剪刀</div>
                    <div class="gesture-desc">伸出食指和中指，其他手指收起</div>
                </div>
                
                <div class="gesture-item">
                    <div class="gesture-demo">
                        <i class="fas fa-question unknown"></i>
                    </div>
                    <div class="gesture-name unknown">其他手勢</div>
                    <div class="gesture-desc">保持穩定手勢至少2秒</div>
                </div>
            </div>
        </div>
        
        <footer>
            <p>HTML5 包剪揼遊戲（鏡頭手勢版） &copy; 2023 | 使用 MediaPipe 手勢辨識技術</p>
        </footer>
    </div>

    <script>
        // 遊戲變數
        let playerScore = 0;
        let computerScore = 0;
        let totalGames = 0;
        let playerWins = 0;
        let winStreak = 0;
        let maxWinStreak = 0;
        
        // 手勢偵測變數
        let leftHandGesture = 'unknown';
        let rightHandGesture = 'unknown';
        let lastLeftGesture = 'unknown';
        let lastRightGesture = 'unknown';
        let gestureStableCount = { left: 0, right: 0 };
        const GESTURE_STABLE_THRESHOLD = 10; // 需要連續偵測到相同手勢的幀數
        
        // 遊戲狀態
        let isCameraOn = false;
        let isGameActive = false;
        let handsModel = null;
        
        // DOM 元素
        const cameraFeed = document.getElementById('camera-feed');
        const cameraOverlay = document.getElementById('camera-overlay');
        const permissionMessage = document.getElementById('permission-message');
        const cameraError = document.getElementById('camera-error');
        const errorMessage = document.getElementById('error-message');
        
        const leftHandIcon = document.getElementById('left-hand-icon');
        const leftHandText = document.getElementById('left-hand-text');
        const rightHandIcon = document.getElementById('right-hand-icon');
        const rightHandText = document.getElementById('right-hand-text');
        
        const playerScoreElement = document.getElementById('player-score');
        const computerScoreElement = document.getElementById('computer-score');
        const resultTextElement = document.getElementById('result-text');
        const gameInfoElement = document.getElementById('game-info');
        
        const startCameraBtn = document.getElementById('start-camera-btn');
        const stopCameraBtn = document.getElementById('stop-camera-btn');
        const playButton = document.getElementById('play-btn');
        const resetButton = document.getElementById('reset-btn');
        const requestPermissionBtn = document.getElementById('request-permission-btn');
        const retryCameraBtn = document.getElementById('retry-camera-btn');
        
        // 手勢對應的圖標和文字
        const gestureIcons = {
            rock: '<i class="fas fa-hand-rock rock"></i>',
            paper: '<i class="fas fa-hand-paper paper"></i>',
            scissors: '<i class="fas fa-hand-scissors scissors"></i>',
            unknown: '<i class="fas fa-question unknown"></i>'
        };
        
        const gestureTexts = {
            rock: '石頭',
            paper: '布',
            scissors: '剪刀',
            unknown: '未偵測'
        };
        
        // 初始化遊戲
        function initGame() {
            playerScore = 0;
            computerScore = 0;
            totalGames = 0;
            playerWins = 0;
            winStreak = 0;
            maxWinStreak = 0;
            
            leftHandGesture = 'unknown';
            rightHandGesture = 'unknown';
            lastLeftGesture = 'unknown';
            lastRightGesture = 'unknown';
            gestureStableCount = { left: 0, right: 0 };
            
            updateUI();
            resultTextElement.textContent = '開啟鏡頭後顯示手勢';
            resultTextElement.className = '';
            gameInfoElement.textContent = '請將手放在鏡頭前，系統會自動偵測手勢';
            
            // 重置手勢顯示
            updateHandDisplay();
        }
        
        // 更新UI顯示
        function updateUI() {
            playerScoreElement.textContent = playerScore;
            computerScoreElement.textContent = computerScore;
        }
        
        // 更新手勢顯示
        function updateHandDisplay() {
            leftHandIcon.innerHTML = gestureIcons[leftHandGesture];
            leftHandText.textContent = gestureTexts[leftHandGesture];
            leftHandText.className = leftHandGesture;
            
            rightHandIcon.innerHTML = gestureIcons[rightHandGesture];
            rightHandText.textContent = gestureTexts[rightHandGesture];
            rightHandText.className = rightHandGesture;
        }
        
        // 初始化MediaPipe手勢辨識
        function initHandDetection() {
            handsModel = new Hands({
                locateFile: (file) => {
                    return `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`;
                }
            });
            
            handsModel.setOptions({
                maxNumHands: 2,
                modelComplexity: 1,
                minDetectionConfidence: 0.5,
                minTrackingConfidence: 0.5
            });
            
            handsModel.onResults(onHandResults);
        }
        
        // 處理手勢辨識結果
        function onHandResults(results) {
            const canvasCtx = cameraOverlay.getContext('2d');
            const videoWidth = cameraFeed.videoWidth;
            const videoHeight = cameraFeed.videoHeight;
            
            // 設定canvas尺寸
            cameraOverlay.width = videoWidth;
            cameraOverlay.height = videoHeight;
            
            // 清除canvas
            canvasCtx.save();
            canvasCtx.clearRect(0, 0, cameraOverlay.width, cameraOverlay.height);
            
            // 鏡像反轉
            canvasCtx.scale(-1, 1);
            canvasCtx.translate(-cameraOverlay.width, 0);
            
            // 繪製影像
            canvasCtx.drawImage(results.image, 0, 0, cameraOverlay.width, cameraOverlay.height);
            
            // 重置轉換
            canvasCtx.restore();
            
            // 重置手勢狀態
            leftHandGesture = 'unknown';
            rightHandGesture = 'unknown';
            
            // 如果有偵測到手
            if (results.multiHandLandmarks && results.multiHandLandmarks.length > 0) {
                // 處理每隻手
                results.multiHandLandmarks.forEach((landmarks, index) => {
                    const handedness = results.multiHandedness[index].label; // "Left" 或 "Right"
                    const isLeftHand = handedness === "Right"; // MediaPipe回傳的手性是相反的
                    
                    // 辨識手勢
                    const gesture = recognizeGesture(landmarks);
                    
                    // 更新手勢狀態
                    if (isLeftHand) {
                        updateGestureState('left', gesture);
                    } else {
                        updateGestureState('right', gesture);
                    }
                    
                    // 繪製手部關鍵點
                    drawHandLandmarks(canvasCtx, landmarks, isLeftHand);
                });
            }
            
            // 更新手勢顯示
            updateHandDisplay();
            
            // 如果遊戲進行中，自動偵測玩家選擇
            if (isGameActive) {
                autoDetectPlayerChoice();
            }
        }
        
        // 更新手勢狀態（穩定性檢查）
        function updateGestureState(hand, newGesture) {
            if (hand === 'left') {
                if (newGesture === lastLeftGesture) {
                    gestureStableCount.left++;
                    if (gestureStableCount.left >= GESTURE_STABLE_THRESHOLD) {
                        leftHandGesture = newGesture;
                    }
                } else {
                    lastLeftGesture = newGesture;
                    gestureStableCount.left = 0;
                }
            } else {
                if (newGesture === lastRightGesture) {
                    gestureStableCount.right++;
                    if (gestureStableCount.right >= GESTURE_STABLE_THRESHOLD) {
                        rightHandGesture = newGesture;
                    }
                } else {
                    lastRightGesture = newGesture;
                    gestureStableCount.right = 0;
                }
            }
        }
        
        // 辨識手勢
        function recognizeGesture(landmarks) {
            // 取得關鍵點
            const thumbTip = landmarks[4];
            const indexTip = landmarks[8];
            const middleTip = landmarks[12];
            const ringTip = landmarks[16];
            const pinkyTip = landmarks[20];
            const wrist = landmarks[0];
            
            // 計算手指到手腕的距離
            const thumbDistance = Math.sqrt(
                Math.pow(thumbTip.x - wrist.x, 2) + 
                Math.pow(thumbTip.y - wrist.y, 2)
            );
            
            const indexDistance = Math.sqrt(
                Math.pow(indexTip.x - wrist.x, 2) + 
                Math.pow(indexTip.y - wrist.y, 2)
            );
            
            const middleDistance = Math.sqrt(
                Math.pow(middleTip.x - wrist.x, 2) + 
                Math.pow(middleTip.y - wrist.y, 2)
            );
            
            const ringDistance = Math.sqrt(
                Math.pow(ringTip.x - wrist.x, 2) + 
                Math.pow(ringTip.y - wrist.y, 2)
            );
            
            const pinkyDistance = Math.sqrt(
                Math.pow(pinkyTip.x - wrist.x, 2) + 
                Math.pow(pinkyTip.y - wrist.y, 2)
            );
            
            // 計算平均距離
            const avgDistance = (indexDistance + middleDistance + ringDistance + pinkyDistance) / 4;
            
            // 辨識手勢
            if (thumbDistance < 0.1 && indexDistance < 0.1 && middleDistance < 0.1 && ringDistance < 0.1 && pinkyDistance < 0.1) {
                return 'rock'; // 拳頭（石頭）
            } else if (indexDistance > 0.2 && middleDistance > 0.2 && ringDistance < 0.15 && pinkyDistance < 0.15) {
                return 'scissors'; // 食指和中指伸出（剪刀）
            } else if (indexDistance > 0.2 && middleDistance > 0.2 && ringDistance > 0.2 && pinkyDistance > 0.2) {
                return 'paper'; // 所有手指伸出（布）
            }
            
            return 'unknown';
        }
        
        // 繪製手部關鍵點
        function drawHandLandmarks(ctx, landmarks, isLeftHand) {
            const color = isLeftHand ? '#00ff00' : '#ff0000';
            
            // 繪製關鍵點
            for (let i = 0; i < landmarks.length; i++) {
                const x = landmarks[i].x * cameraOverlay.width;
                const y = landmarks[i].y * cameraOverlay.height;
                
                ctx.beginPath();
                ctx.arc(x, y, 5, 0, 2 * Math.PI);
                ctx.fillStyle = color;
                ctx.fill();
            }
            
            // 繪製連接線
            const connections = [
                [0, 1], [1, 2], [2, 3], [3, 4], // 拇指
                [0, 5], [5, 6], [6, 7], [7, 8], // 食指
                [0, 9], [9, 10], [10, 11], [11, 12], // 中指
                [0, 13], [13, 14], [14, 15], [15, 16], // 無名指
                [0, 17], [17, 18], [18, 19], [19, 20], // 小指
                [5, 9], [9, 13], [13, 17] // 手掌
            ];
            
            ctx.strokeStyle = color;
            ctx.lineWidth = 2;
            
            connections.forEach(([start, end]) => {
                const startX = landmarks[start].x * cameraOverlay.width;
                const startY = landmarks[start].y * cameraOverlay.height;
                const endX = landmarks[end].x * cameraOverlay.width;
                const endY = landmarks[end].y * cameraOverlay.height;
                
                ctx.beginPath();
                ctx.moveTo(startX, startY);
                ctx.lineTo(endX, endY);
                ctx.stroke();
            });
        }
        
        // 自動偵測玩家選擇
        function autoDetectPlayerChoice() {
            // 優先使用右手，如果右手未偵測到則使用左手
            let playerGesture = rightHandGesture !== 'unknown' ? rightHandGesture : leftHandGesture;
            
            // 如果偵測到手勢，開始遊戲
            if (playerGesture !== 'unknown') {
                playGame(playerGesture);
            }
        }
        
        // 電腦隨機選擇
        function getComputerChoice() {
            const choices = ['rock', 'paper', 'scissors'];
            const randomIndex = Math.floor(Math.random() * 3);
            return choices[randomIndex];
        }
        
        // 決定勝負
        function determineWinner(player, computer) {
            if (player === computer) return 'draw';
            
            if (
                (player === 'rock' && computer === 'scissors') ||
                (player === 'paper' && computer === 'rock') ||
                (player === 'scissors' && computer === 'paper')
            ) {
                return 'player';
            }
            
            return 'computer';
        }
        
        // 播放遊戲
        function playGame(playerGesture) {
            if (!isCameraOn || playerGesture === 'unknown') {
                gameInfoElement.textContent = '請開啟鏡頭並顯示正確手勢！';
                resultTextElement.classList.add('shake');
                setTimeout(() => {
                    resultTextElement.classList.remove('shake');
                }, 500);
                return;
            }
            
            // 電腦選擇
            const computerChoice = getComputerChoice();
            
            // 決定勝負
            const winner = determineWinner(playerGesture, computerChoice);
            
            // 更新分數和統計
            totalGames++;
            
            let resultText = '';
            let resultClass = '';
            
            if (winner === 'player') {
                playerScore++;
                playerWins++;
                winStreak++;
                maxWinStreak = Math.max(maxWinStreak, winStreak);
                resultText = '你贏了！';
                resultClass = 'win';
                gameInfoElement.textContent = `${gestureTexts[playerGesture]} 贏 ${gestureTexts[computerChoice]}`;
            } else if (winner === 'computer') {
                computerScore++;
                winStreak = 0;
                resultText = '電腦贏了！';
                resultClass = 'lose';
                gameInfoElement.textContent = `${gestureTexts[computerChoice]} 贏 ${gestureTexts[playerGesture]}`;
            } else {
                resultText = '平手！';
                resultClass = 'draw';
                gameInfoElement.textContent = '雙方選擇相同';
            }
            
            // 更新結果顯示
            resultTextElement.textContent = resultText;
            resultTextElement.className = resultClass;
            
            // 更新統計數據
            updateUI();
            
            // 添加動畫效果
            resultTextElement.classList.add('pulse');
            setTimeout(() => {
                resultTextElement.classList.remove('pulse');
            }, 1000);
            
            // 重置遊戲狀態
            isGameActive = false;
            playButton.innerHTML = '<i class="fas fa-fist-raised"></i> 開始遊戲';
        }
        
        // 開始鏡頭
        async function startCamera() {
            try {
                permissionMessage.style.display = 'none';
                cameraError.style.display = 'none';
                
                // 請求鏡頭權限
                const stream = await navigator.mediaDevices.getUserMedia({
                    video: {
                        width: { ideal: 640 },
                        height: { ideal: 480 },
                        facingMode: 'user'
                    },
                    audio: false
                });
                
                // 設定影像來源
                cameraFeed.srcObject = stream;
                isCameraOn = true;
                
                // 初始化手勢辨識
                if (!handsModel) {
                    initHandDetection();
                }
                
                // 開始處理影像
                const camera = new Camera(cameraFeed, {
                    onFrame: async () => {
                        if (isCameraOn) {
                            await handsModel.send({image: cameraFeed});
                        }
                    },
                    width: 640,
                    height: 480
                });
                
                camera.start();
                
                // 更新UI
                startCameraBtn.disabled = true;
                stopCameraBtn.disabled = false;
                playButton.disabled = false;
                
                gameInfoElement.textContent = '鏡頭已開啟，請將手放在鏡頭前';
                
            } catch (error) {
                console.error('無法存取鏡頭:', error);
                cameraError.style.display = 'flex';
                errorMessage.textContent = `錯誤: ${error.message}`;
                isCameraOn = false;
            }
        }
        
        // 停止鏡頭
        function stopCamera() {
            if (cameraFeed.srcObject) {
                const tracks = cameraFeed.srcObject.getTracks();
                tracks.forEach(track => track.stop());
                cameraFeed.srcObject = null;
            }
            
            isCameraOn = false;
            isGameActive = false;
            
            // 更新UI
            startCameraBtn.disabled = false;
            stopCameraBtn.disabled = true;
            playButton.disabled = true;
            playButton.innerHTML = '<i class="fas fa-fist-raised"></i> 開始遊戲';
            
            // 清空canvas
            const canvasCtx = cameraOverlay.getContext('2d');
            canvasCtx.clearRect(0, 0, cameraOverlay.width, cameraOverlay.height);
            
            // 重置手勢顯示
            leftHandGesture = 'unknown';
            rightHandGesture = 'unknown';
            updateHandDisplay();
            
            gameInfoElement.textContent = '鏡頭已關閉';
        }
        
        // 重置遊戲
        function resetGame() {
            initGame();
            
            // 顯示重置訊息
            resultTextElement.textContent = '遊戲已重置！';
            resultTextElement.className = 'draw';
            gameInfoElement.textContent = '請開啟鏡頭開始遊戲';
            
            // 添加動畫效果
            resultTextElement.classList.add('glow');
            setTimeout(() => {
                resultTextElement.classList.remove('glow');
            }, 2000);
        }
        
        // 事件監聽器
        startCameraBtn.addEventListener('click', startCamera);
        stopCameraBtn.addEventListener('click', stopCamera);
        
        playButton.addEventListener('click', () => {
            if (!isCameraOn) {
                gameInfoElement.textContent = '請先開啟鏡頭！';
                return;
            }
            
            if (!isGameActive) {
                isGameActive = true;
                playButton.innerHTML = '<i class="fas fa-hourglass-half"></i> 偵測手勢中...';
                gameInfoElement.textContent = '請將手放在鏡頭前，系統會自動偵測手勢';
                resultTextElement.textContent = '偵測手勢中...';
                resultTextElement.className = '';
            }
        });
        
        resetButton.addEventListener('click', resetGame);
        
        requestPermissionBtn.addEventListener('click', startCamera);
        retryCameraBtn.addEventListener('click', startCamera);
        
        // 初始化
        function init() {
            // 初始設定
            stopCameraBtn.disabled = true;
            playButton.disabled = true;
            
            // 檢查瀏覽器是否支援
            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                permissionMessage.style.display = 'none';
                cameraError.style.display = 'flex';
                errorMessage.textContent = '您的瀏覽器不支援鏡頭功能，請使用最新版的Chrome、Edge或Firefox瀏覽器。';
            }
            
            // 初始化遊戲
            initGame();
        }
        
        // 頁面載入時初始化
        window.addEventListener('DOMContentLoaded', init);
        
        // 鍵盤控制
        document.addEventListener('keydown', (event) => {
            switch(event.key) {
                case ' ':
                case 'Enter':
                    if (isCameraOn && !isGameActive) {
                        playButton.click();
                    }
                    break;
                case 'Escape':
                    resetButton.click();
                    break;
                case '1':
                    if (isCameraOn) {
                        startCameraBtn.click();
                    }
                    break;
                case '2':
                    if (isCameraOn) {
                        stopCameraBtn.click();
                    }
                    break;
            }
        });
    </script>
</body>
</html>