<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>包剪揼遊戲 - 終極版</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js" crossorigin="anonymous"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', 'Microsoft JhengHei', sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #0a0a2a 0%, #1a1a4a 50%, #0a0a2a 100%);
            color: #fff;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        header {
            text-align: center;
            margin-bottom: 30px;
            width: 100%;
        }
        
        h1 {
            font-size: 3.5rem;
            margin-bottom: 10px;
            background: linear-gradient(90deg, #00c6ff, #0072ff);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
        }
        
        .subtitle {
            font-size: 1.2rem;
            color: #7db9ff;
            margin-bottom: 20px;
        }
        
        .game-area {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            width: 100%;
            margin-bottom: 40px;
        }
        
        @media (max-width: 1024px) {
            .game-area {
                grid-template-columns: 1fr;
            }
        }
        
        .camera-section, .game-section {
            background: rgba(0, 20, 60, 0.6);
            border-radius: 20px;
            padding: 25px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(0, 114, 255, 0.3);
        }
        
        .section-title {
            font-size: 1.8rem;
            margin-bottom: 20px;
            color: #00c6ff;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        #camera-container {
            position: relative;
            width: 100%;
            height: 400px;
            border-radius: 15px;
            overflow: hidden;
            background: linear-gradient(45deg, #001233, #001845);
            margin-bottom: 20px;
            box-shadow: 0 0 20px rgba(0, 114, 255, 0.3);
        }
        
        #camera-feed {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transform: scaleX(-1);
        }
        
        #camera-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }
        
        .hand-guide {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 180px;
            height: 180px;
            border: 3px dashed rgba(0, 198, 255, 0.6);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 5;
            pointer-events: none;
            box-shadow: 0 0 20px rgba(0, 198, 255, 0.3);
        }
        
        .hand-guide-text {
            color: rgba(0, 198, 255, 0.9);
            font-size: 1.1rem;
            font-weight: bold;
            text-align: center;
            text-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
        }
        
        .gesture-feedback {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(0, 20, 60, 0.8);
            padding: 12px 15px;
            border-radius: 10px;
            z-index: 10;
            backdrop-filter: blur(5px);
            border: 1px solid rgba(0, 114, 255, 0.2);
        }
        
        .camera-controls {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 20px;
            flex-wrap: wrap;
        }
        
        .control-btn {
            padding: 12px 24px;
            font-size: 1.1rem;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 10px;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.4);
        }
        
        #start-camera-btn {
            background: linear-gradient(90deg, #00c6ff, #0072ff);
            color: white;
        }
        
        #stop-camera-btn {
            background: linear-gradient(90deg, #ff416c, #ff4b2b);
            color: white;
        }
        
        .control-btn:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 25px rgba(0, 0, 0, 0.5);
        }
        
        #start-camera-btn:hover {
            background: linear-gradient(90deg, #00b4e6, #0066e0);
        }
        
        #stop-camera-btn:hover {
            background: linear-gradient(90deg, #e63a5f, #e6392a);
        }
        
        .hand-status {
            display: flex;
            justify-content: space-around;
            margin-top: 20px;
            flex-wrap: wrap;
        }
        
        .hand-info {
            text-align: center;
            padding: 15px;
            background: rgba(0, 40, 100, 0.4);
            border-radius: 10px;
            min-width: 180px;
            margin: 5px;
            border: 1px solid rgba(0, 114, 255, 0.2);
        }
        
        .hand-label {
            font-size: 1.2rem;
            margin-bottom: 10px;
            color: #00c6ff;
        }
        
        .gesture-icon {
            font-size: 3rem;
            margin-bottom: 10px;
            height: 60px;
        }
        
        .gesture-text {
            font-size: 1.5rem;
            font-weight: bold;
        }
        
        .rock { color: #ff416c; }
        .paper { color: #36D1DC; }
        .scissors { color: #7AFF8E; }
        .unknown { color: #7db9ff; }
        
        .game-section {
            display: flex;
            flex-direction: column;
        }
        
        .score-board {
            display: flex;
            justify-content: space-around;
            margin-bottom: 30px;
        }
        
        .score-item {
            text-align: center;
            padding: 20px;
            background: rgba(0, 40, 100, 0.4);
            border-radius: 15px;
            min-width: 150px;
            border: 1px solid rgba(0, 114, 255, 0.2);
        }
        
        .score-label {
            font-size: 1.2rem;
            margin-bottom: 10px;
            color: #00c6ff;
        }
        
        .score-value {
            font-size: 3rem;
            font-weight: bold;
            color: #0072ff;
            text-shadow: 0 0 10px rgba(0, 114, 255, 0.5);
        }
        
        .result-area {
            text-align: center;
            padding: 25px;
            background: rgba(0, 40, 100, 0.4);
            border-radius: 15px;
            margin-bottom: 30px;
            border: 1px solid rgba(0, 114, 255, 0.2);
        }
        
        #result-text {
            font-size: 2.5rem;
            margin-bottom: 15px;
            min-height: 70px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .win { color: #7AFF8E; text-shadow: 0 0 10px rgba(122, 255, 142, 0.7); }
        .lose { color: #ff416c; text-shadow: 0 0 10px rgba(255, 65, 108, 0.7); }
        .draw { color: #36D1DC; text-shadow: 0 0 10px rgba(54, 209, 220, 0.7); }
        
        #game-info {
            font-size: 1.2rem;
            color: #00c6ff;
            margin-bottom: 10px;
        }
        
        .game-controls {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: auto;
            flex-wrap: wrap;
        }
        
        .action-btn {
            padding: 15px 30px;
            font-size: 1.2rem;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 10px;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.4);
        }
        
        #play-btn {
            background: linear-gradient(90deg, #00c6ff, #0072ff);
            color: white;
        }
        
        #reset-btn {
            background: rgba(0, 114, 255, 0.2);
            color: white;
            border: 1px solid rgba(0, 114, 255, 0.4);
        }
        
        .action-btn:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 25px rgba(0, 0, 0, 0.5);
        }
        
        #play-btn:hover {
            background: linear-gradient(90deg, #00b4e6, #0066e0);
        }
        
        #reset-btn:hover {
            background: rgba(0, 114, 255, 0.3);
        }
        
        .rules-panel {
            margin-top: 40px;
            width: 100%;
            background: rgba(0, 20, 60, 0.6);
            padding: 25px;
            border-radius: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(0, 114, 255, 0.3);
        }
        
        .rules-panel h3 {
            font-size: 1.8rem;
            margin-bottom: 20px;
            color: #0072ff;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .rules-content {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 25px;
        }
        
        .rule-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            padding: 20px;
            background: rgba(0, 40, 100, 0.4);
            border-radius: 15px;
            border: 1px solid rgba(0, 114, 255, 0.2);
        }
        
        .rule-icon {
            font-size: 4rem;
            margin-bottom: 15px;
            height: 80px;
        }
        
        .rule-title {
            font-size: 1.5rem;
            font-weight: bold;
            margin-bottom: 10px;
            color: #00c6ff;
        }
        
        .rule-desc {
            font-size: 1rem;
            color: #b3d9ff;
            line-height: 1.5;
        }
        
        .permission-message {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 10, 30, 0.95);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            padding: 20px;
            z-index: 100;
            border-radius: 15px;
        }
        
        .permission-message h3 {
            color: #00c6ff;
            margin-bottom: 20px;
            font-size: 1.8rem;
        }
        
        .permission-message p {
            margin-bottom: 30px;
            color: #b3d9ff;
            max-width: 500px;
            line-height: 1.6;
        }
        
        #camera-error {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 10, 30, 0.95);
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            padding: 20px;
            z-index: 100;
            border-radius: 15px;
        }
        
        #camera-error h3 {
            color: #ff416c;
            margin-bottom: 20px;
            font-size: 1.8rem;
        }
        
        #camera-error p {
            margin-bottom: 30px;
            color: #b3d9ff;
            max-width: 500px;
            line-height: 1.6;
        }
        
        .detection-help {
            margin-top: 15px;
            text-align: center;
            padding: 15px;
            background: rgba(0, 198, 255, 0.1);
            border-radius: 10px;
            border-left: 4px solid #00c6ff;
        }
        
        .help-title {
            font-weight: bold;
            color: #00c6ff;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .help-item {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 5px;
            font-size: 0.95rem;
            color: #b3d9ff;
        }
        
        .help-item i {
            color: #36D1DC;
        }
        
        .gesture-on-hand {
            position: absolute;
            pointer-events: none;
            z-index: 8;
            font-size: 2rem;
            opacity: 0.9;
            filter: drop-shadow(0 0 5px rgba(255, 255, 255, 0.5));
        }
        
        footer {
            margin-top: 40px;
            text-align: center;
            color: #00c6ff;
            font-size: 1rem;
            padding: 20px;
            width: 100%;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.05); opacity: 0.8; }
            100% { transform: scale(1); opacity: 1; }
        }
        
        .pulse {
            animation: pulse 1s ease infinite;
        }
        
        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }
        
        .bounce {
            animation: bounce 0.5s ease infinite;
        }
        
        @keyframes glow {
            0%, 100% { box-shadow: 0 0 10px rgba(0, 198, 255, 0.7); }
            50% { box-shadow: 0 0 25px rgba(0, 198, 255, 1); }
        }
        
        .glow {
            animation: glow 1s ease infinite;
        }
        
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }
        
        .shake {
            animation: shake 0.3s ease;
        }
        
        .detected {
            border-color: #7AFF8E !important;
            box-shadow: 0 0 20px rgba(122, 255, 142, 0.5);
        }
        
        .countdown {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 5rem;
            font-weight: bold;
            color: #00c6ff;
            text-shadow: 0 0 20px rgba(0, 198, 255, 0.7);
            z-index: 20;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1><i class="fas fa-hand-rock"></i> 包剪揼遊戲 <i class="fas fa-hand-scissors"></i></h1>
            <p class="subtitle">用手勢玩最經典的包剪揼遊戲！</p>
        </header>
        
        <div class="game-area">
            <div class="camera-section">
                <h2 class="section-title"><i class="fas fa-hand-paper"></i> 手勢偵測</h2>
                
                <div id="camera-container">
                    <video id="camera-feed" autoplay playsinline></video>
                    <canvas id="camera-overlay"></canvas>
                    
                    <div class="hand-guide">
                        <div class="hand-guide-text">把手放在這裡</div>
                    </div>
                    
                    <div class="gesture-feedback">
                        <div id="gesture-status">等待手部...</div>
                        <div id="gesture-help" style="font-size: 0.9rem; color: #7db9ff;">請將手掌放入圓圈中</div>
                    </div>
                    
                    <div id="permission-message" class="permission-message">
                        <h3><i class="fas fa-camera"></i> 需要鏡頭權限</h3>
                        <p>請允許使用鏡頭以偵測手勢。您的影像資料只會在瀏覽器內處理，不會傳送到任何伺服器。</p>
                        <button id="request-permission-btn" class="control-btn">
                            <i class="fas fa-camera"></i> 允許使用鏡頭
                        </button>
                    </div>
                    
                    <div id="camera-error" class="permission-message">
                        <h3><i class="fas fa-exclamation-triangle"></i> 無法存取鏡頭</h3>
                        <p id="error-message">無法存取您的鏡頭裝置。請檢查瀏覽器設定或連接的鏡頭。</p>
                        <button id="retry-camera-btn" class="control-btn">
                            <i class="fas fa-redo"></i> 重試
                        </button>
                    </div>
                </div>
                
                <div class="detection-help">
                    <div class="help-title"><i class="fas fa-lightbulb"></i> 剪刀手勢小技巧</div>
                    <div class="help-item"><i class="fas fa-check-circle"></i> 食指和中指伸直，呈V字形</div>
                    <div class="help-item"><i class="fas fa-check-circle"></i> 其他手指完全收起</div>
                    <div class="help-item"><i class="fas fa-check-circle"></i> 拇指放在手掌側面</div>
                </div>
                
                <div class="camera-controls">
                    <button id="start-camera-btn" class="control-btn">
                        <i class="fas fa-play"></i> 開啟鏡頭
                    </button>
                    <button id="stop-camera-btn" class="control-btn">
                        <i class="fas fa-stop"></i> 關閉鏡頭
                    </button>
                </div>
                
                <div class="hand-status">
                    <div class="hand-info">
                        <div class="hand-label">偵測狀態</div>
                        <div id="hand-icon" class="gesture-icon">
                            <i class="fas fa-hand-paper bounce"></i>
                        </div>
                        <div id="hand-text" class="gesture-text">準備中</div>
                        <div id="hand-confidence" style="font-size: 0.9rem; color: #7db9ff;">信心度: 0%</div>
                    </div>
                    
                    <div class="hand-info">
                        <div class="hand-label">當前手勢</div>
                        <div id="gesture-icon" class="gesture-icon">
                            <i class="fas fa-question unknown"></i>
                        </div>
                        <div id="gesture-text" class="gesture-text unknown">未偵測</div>
                        <div id="gesture-timer" style="font-size: 0.9rem; color: #7db9ff;">穩定: 0秒</div>
                    </div>
                </div>
            </div>
            
            <div class="game-section">
                <h2 class="section-title"><i class="fas fa-gamepad"></i> 遊戲狀態</h2>
                
                <div class="score-board">
                    <div class="score-item">
                        <div class="score-label">玩家</div>
                        <div class="score-value" id="player-score">0</div>
                    </div>
                    
                    <div class="score-item">
                        <div class="score-label">電腦</div>
                        <div class="score-value" id="computer-score">0</div>
                    </div>
                </div>
                
                <div class="result-area">
                    <div id="result-text">開啟鏡頭開始遊戲</div>
                    <div id="game-info">將手掌放入中央圓圈，保持手勢2秒</div>
                </div>
                
                <div class="game-controls">
                    <button class="action-btn" id="play-btn">
                        <i class="fas fa-fist-raised"></i> 開始遊戲
                    </button>
                    
                    <button class="action-btn" id="reset-btn">
                        <i class="fas fa-redo"></i> 重新開始
                    </button>
                </div>
                
                <div class="detection-help" style="margin-top: 20px;">
                    <div class="help-title"><i class="fas fa-gesture"></i> 手勢辨識規則</div>
                    <div class="help-item"><i class="fas fa-fist-raised rock"></i> <strong>石頭</strong>：握緊拳頭</div>
                    <div class="help-item"><i class="fas fa-hand-paper paper"></i> <strong>布</strong>：張開手掌</div>
                    <div class="help-item"><i class="fas fa-hand-peace scissors"></i> <strong>剪刀</strong>：食指+中指伸直</div>
                </div>
            </div>
        </div>
        
        <div class="rules-panel">
            <h3><i class="fas fa-book"></i> 包剪揼遊戲規則</h3>
            <div class="rules-content">
                <div class="rule-item">
                    <div class="rule-icon">
                        <i class="fas fa-fist-raised rock"></i>
                    </div>
                    <div class="rule-title">石頭贏剪刀</div>
                    <div class="rule-desc">石頭可以打壞剪刀，所以石頭贏剪刀</div>
                </div>
                
                <div class="rule-item">
                    <div class="rule-icon">
                        <i class="fas fa-hand-paper paper"></i>
                    </div>
                    <div class="rule-title">布贏石頭</div>
                    <div class="rule-desc">布可以包住石頭，所以布贏石頭</div>
                </div>
                
                <div class="rule-item">
                    <div class="rule-icon">
                        <i class="fas fa-hand-peace scissors"></i>
                    </div>
                    <div class="rule-title">剪刀贏布</div>
                    <div class="rule-desc">剪刀可以剪開布，所以剪刀贏布</div>
                </div>
                
                <div class="rule-item">
                    <div class="rule-icon">
                        <i class="fas fa-equals" style="color: #00c6ff;"></i>
                    </div>
                    <div class="rule-title">相同為平手</div>
                    <div class="rule-desc">如果雙方出相同手勢，則為平手</div>
                </div>
            </div>
        </div>
        
        <footer>
            <p>HTML5 包剪揼遊戲 &copy; 2023 | 用手勢體驗經典遊戲</p>
        </footer>
    </div>

    <script>
        // 遊戲變數
        let playerScore = 0;
        let computerScore = 0;
        let totalGames = 0;
        let playerWins = 0;
        let winStreak = 0;
        let maxWinStreak = 0;
        
        // 手勢偵測變數
        let currentGesture = 'unknown';
        let currentConfidence = 0;
        let gestureStableTime = 0;
        let lastGesture = 'unknown';
        let handDetected = false;
        let handPosition = { x: 0, y: 0 };
        let lastHandGesture = 'unknown';
        let gestureStableCount = 0;
        
        // 遊戲狀態
        let isCameraOn = false;
        let isGameActive = false;
        let isCountdownActive = false;
        let countdownValue = 3;
        let handsModel = null;
        
        // DOM 元素
        const cameraFeed = document.getElementById('camera-feed');
        const cameraOverlay = document.getElementById('camera-overlay');
        const permissionMessage = document.getElementById('permission-message');
        const cameraError = document.getElementById('camera-error');
        const errorMessage = document.getElementById('error-message');
        
        const handIcon = document.getElementById('hand-icon');
        const handText = document.getElementById('hand-text');
        const handConfidenceElement = document.getElementById('hand-confidence');
        const gestureIcon = document.getElementById('gesture-icon');
        const gestureText = document.getElementById('gesture-text');
        const gestureTimer = document.getElementById('gesture-timer');
        const gestureStatus = document.getElementById('gesture-status');
        const gestureHelp = document.getElementById('gesture-help');
        
        const playerScoreElement = document.getElementById('player-score');
        const computerScoreElement = document.getElementById('computer-score');
        const resultTextElement = document.getElementById('result-text');
        const gameInfoElement = document.getElementById('game-info');
        
        const startCameraBtn = document.getElementById('start-camera-btn');
        const stopCameraBtn = document.getElementById('stop-camera-btn');
        const playButton = document.getElementById('play-btn');
        const resetButton = document.getElementById('reset-btn');
        const requestPermissionBtn = document.getElementById('request-permission-btn');
        const retryCameraBtn = document.getElementById('retry-camera-btn');
        
        // 手勢對應的圖標和顏色
        const gestureData = {
            rock: {
                icon: 'fas fa-fist-raised',
                text: '石頭',
                color: '#ff416c'
            },
            paper: {
                icon: 'fas fa-hand-paper',
                text: '布',
                color: '#36D1DC'
            },
            scissors: {
                icon: 'fas fa-hand-peace',
                text: '剪刀',
                color: '#7AFF8E'
            },
            unknown: {
                icon: 'fas fa-question',
                text: '未偵測',
                color: '#7db9ff'
            }
        };
        
        // 初始化遊戲
        function initGame() {
            playerScore = 0;
            computerScore = 0;
            totalGames = 0;
            playerWins = 0;
            winStreak = 0;
            maxWinStreak = 0;
            
            currentGesture = 'unknown';
            currentConfidence = 0;
            gestureStableTime = 0;
            lastGesture = 'unknown';
            handDetected = false;
            lastHandGesture = 'unknown';
            gestureStableCount = 0;
            
            updateUI();
            resultTextElement.textContent = '開啟鏡頭開始遊戲';
            resultTextElement.className = '';
            gameInfoElement.textContent = '將手掌放入中央圓圈，保持手勢2秒';
            
            updateHandDisplay();
            updateGestureDisplay();
        }
        
        // 更新UI顯示
        function updateUI() {
            playerScoreElement.textContent = playerScore;
            computerScoreElement.textContent = computerScore;
        }
        
        // 更新手部偵測顯示
        function updateHandDisplay() {
            if (handDetected) {
                handIcon.innerHTML = `<i class="fas fa-hand-paper" style="color: #36D1DC"></i>`;
                handText.textContent = '手部已偵測';
                handText.style.color = '#36D1DC';
                handConfidenceElement.textContent = `信心度: ${Math.round(currentConfidence * 100)}%`;
                handConfidenceElement.style.color = currentConfidence > 0.7 ? '#7AFF8E' : 
                                                  currentConfidence > 0.4 ? '#FFD700' : '#ff416c';
                handIcon.classList.add('bounce');
            } else {
                handIcon.innerHTML = `<i class="fas fa-hand-paper" style="color: #7db9ff"></i>`;
                handText.textContent = '準備中';
                handText.style.color = '#7db9ff';
                handConfidenceElement.textContent = '信心度: 0%';
                handConfidenceElement.style.color = '#7db9ff';
                handIcon.classList.remove('bounce');
            }
        }
        
        // 更新手勢顯示
        function updateGestureDisplay() {
            const gestureDataItem = gestureData[currentGesture] || gestureData.unknown;
            
            gestureIcon.innerHTML = `<i class="${gestureDataItem.icon}" style="color: ${gestureDataItem.color}"></i>`;
            gestureText.textContent = gestureDataItem.text;
            gestureText.style.color = gestureDataItem.color;
            
            if (currentGesture !== 'unknown') {
                gestureTimer.textContent = `穩定: ${gestureStableTime.toFixed(1)}秒`;
                gestureTimer.style.color = gestureStableTime >= 2 ? '#7AFF8E' : '#FFD700';
            } else {
                gestureTimer.textContent = '穩定: 0秒';
                gestureTimer.style.color = '#7db9ff';
            }
        }
        
        // 初始化MediaPipe手勢辨識
        function initHandDetection() {
            handsModel = new Hands({
                locateFile: (file) => {
                    return `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`;
                }
            });
            
            // 優化設定以偵測剪刀手勢
            handsModel.setOptions({
                maxNumHands: 1,
                modelComplexity: 1, // 使用中等複雜度
                minDetectionConfidence: 0.6,
                minTrackingConfidence: 0.6,
                selfieMode: true
            });
            
            handsModel.onResults(onHandResults);
        }
        
        // 處理手勢辨識結果
        function onHandResults(results) {
            const canvasCtx = cameraOverlay.getContext('2d');
            const videoWidth = cameraFeed.videoWidth;
            const videoHeight = cameraFeed.videoHeight;
            
            // 設定canvas尺寸
            cameraOverlay.width = videoWidth;
            cameraOverlay.height = videoHeight;
            
            // 清除canvas
            canvasCtx.clearRect(0, 0, cameraOverlay.width, cameraOverlay.height);
            
            // 計算中央圓圈位置和大小
            const centerX = cameraOverlay.width / 2;
            const centerY = cameraOverlay.height / 2;
            const circleRadius = Math.min(cameraOverlay.width, cameraOverlay.height) * 0.18;
            
            // 繪製中央圓圈
            canvasCtx.beginPath();
            canvasCtx.arc(centerX, centerY, circleRadius, 0, Math.PI * 2);
            canvasCtx.strokeStyle = handDetected ? '#7AFF8E' : 'rgba(0, 198, 255, 0.6)';
            canvasCtx.lineWidth = handDetected ? 4 : 2;
            canvasCtx.stroke();
            
            // 重置手部偵測狀態
            handDetected = false;
            let detectedGesture = 'unknown';
            let detectedConfidence = 0;
            
            // 如果有偵測到手
            if (results.multiHandLandmarks && results.multiHandLandmarks.length > 0) {
                // 只處理第一隻手
                const landmarks = results.multiHandLandmarks[0];
                
                // 計算手部中心點
                const handCenter = calculateHandCenter(landmarks);
                
                // 檢查手部是否在圓圈內
                const distanceToCenter = Math.sqrt(
                    Math.pow(handCenter.x * cameraOverlay.width - centerX, 2) + 
                    Math.pow(handCenter.y * cameraOverlay.height - centerY, 2)
                );
                
                const isInCircle = distanceToCenter < circleRadius;
                
                // 繪製手部骨架
                drawHandSkeleton(canvasCtx, landmarks, isInCircle);
                
                // 繪製手部中心點
                canvasCtx.beginPath();
                canvasCtx.arc(
                    handCenter.x * cameraOverlay.width, 
                    handCenter.y * cameraOverlay.height, 
                    8, 0, Math.PI * 2
                );
                canvasCtx.fillStyle = isInCircle ? '#7AFF8E' : '#ff416c';
                canvasCtx.fill();
                
                // 繪製連線到手部中心
                canvasCtx.beginPath();
                canvasCtx.moveTo(centerX, centerY);
                canvasCtx.lineTo(
                    handCenter.x * cameraOverlay.width, 
                    handCenter.y * cameraOverlay.height
                );
                canvasCtx.strokeStyle = isInCircle ? '#7AFF8E' : '#ff416c';
                canvasCtx.lineWidth = 2;
                canvasCtx.stroke();
                
                if (isInCircle) {
                    handDetected = true;
                    handPosition = {
                        x: handCenter.x * cameraOverlay.width,
                        y: handCenter.y * cameraOverlay.height
                    };
                    
                    // 使用改良版手勢辨識（特別加強剪刀偵測）
                    detectedGesture = recognizeGestureImproved(landmarks);
                    detectedConfidence = calculateConfidenceImproved(landmarks, detectedGesture);
                    
                    // 更新狀態顯示
                    const gestureDataItem = gestureData[detectedGesture] || gestureData.unknown;
                    gestureStatus.textContent = `手勢: ${gestureDataItem.text}`;
                    gestureStatus.style.color = gestureDataItem.color;
                    
                    if (detectedGesture === 'scissors') {
                        gestureHelp.textContent = '剪刀手勢已偵測！保持穩定';
                        gestureHelp.style.color = '#7AFF8E';
                    } else {
                        gestureHelp.textContent = '手勢已偵測，保持穩定';
                        gestureHelp.style.color = '#7db9ff';
                    }
                    
                    // 在手部位置繪製手勢圖標
                    drawGestureIconOnHand(canvasCtx, handPosition.x, handPosition.y, detectedGesture);
                } else {
                    gestureStatus.textContent = '請將手放入圓圈內';
                    gestureStatus.style.color = '#00c6ff';
                    gestureHelp.textContent = '手掌需完全在圓圈範圍內';
                    gestureHelp.style.color = '#7db9ff';
                }
            } else {
                gestureStatus.textContent = '等待手部...';
                gestureStatus.style.color = '#7db9ff';
                gestureHelp.textContent = '請將手掌放入圓圈中';
                gestureHelp.style.color = '#7db9ff';
            }
            
            // 更新手勢穩定性
            if (handDetected && detectedGesture !== 'unknown') {
                if (detectedGesture === lastHandGesture) {
                    gestureStableCount++;
                    if (gestureStableCount > 5) { // 穩定5幀後開始計時
                        gestureStableTime += 0.1; // 假設每幀約0.1秒
                    }
                } else {
                    gestureStableCount = 0;
                    gestureStableTime = 0;
                    lastHandGesture = detectedGesture;
                }
                
                // 更新當前手勢
                currentGesture = detectedGesture;
                currentConfidence = detectedConfidence;
            } else {
                gestureStableCount = 0;
                gestureStableTime = 0;
                currentGesture = 'unknown';
                currentConfidence = 0;
            }
            
            // 更新顯示
            updateHandDisplay();
            updateGestureDisplay();
            
            // 如果遊戲進行中且手勢穩定，開始倒數
            if (isGameActive && handDetected && gestureStableTime >= 2 && !isCountdownActive) {
                startCountdown();
            }
        }
        
        // 計算手部中心點
        function calculateHandCenter(landmarks) {
            // 使用手掌區域的關鍵點計算中心
            const palmPoints = [
                landmarks[0],  // 手腕
                landmarks[5],  // 食指根部
                landmarks[9],  // 中指根部
                landmarks[13], // 無名指根部
                landmarks[17]  // 小指根部
            ];
            
            let sumX = 0, sumY = 0;
            palmPoints.forEach(point => {
                sumX += point.x;
                sumY += point.y;
            });
            
            return {
                x: sumX / palmPoints.length,
                y: sumY / palmPoints.length
            };
        }
        
        // 繪製手部骨架
        function drawHandSkeleton(ctx, landmarks, isInCircle) {
            const color = isInCircle ? '#7AFF8E' : '#ff416c';
            const pointColor = isInCircle ? '#36D1DC' : '#ff416c';
            
            // 繪製關鍵點
            const importantPoints = [0, 4, 8, 12, 16, 20]; // 手腕、指尖
            importantPoints.forEach(index => {
                const point = landmarks[index];
                const x = point.x * cameraOverlay.width;
                const y = point.y * cameraOverlay.height;
                
                ctx.beginPath();
                ctx.arc(x, y, 6, 0, Math.PI * 2);
                ctx.fillStyle = pointColor;
                ctx.fill();
                
                ctx.beginPath();
                ctx.arc(x, y, 8, 0, Math.PI * 2);
                ctx.strokeStyle = '#fff';
                ctx.lineWidth = 1;
                ctx.stroke();
            });
            
            // 繪製連線
            const connections = [
                [0, 1], [1, 2], [2, 3], [3, 4], // 拇指
                [0, 5], [5, 6], [6, 7], [7, 8], // 食指
                [0, 9], [9, 10], [10, 11], [11, 12], // 中指
                [0, 13], [13, 14], [14, 15], [15, 16], // 無名指
                [0, 17], [17, 18], [18, 19], [19, 20]  // 小指
            ];
            
            ctx.strokeStyle = color;
            ctx.lineWidth = 3;
            
            connections.forEach(([startIdx, endIdx]) => {
                const start = landmarks[startIdx];
                const end = landmarks[endIdx];
                
                const startX = start.x * cameraOverlay.width;
                const startY = start.y * cameraOverlay.height;
                const endX = end.x * cameraOverlay.width;
                const endY = end.y * cameraOverlay.height;
                
                ctx.beginPath();
                ctx.moveTo(startX, startY);
                ctx.lineTo(endX, endY);
                ctx.stroke();
            });
        }
        
        // 在手部位置繪製手勢圖標
        function drawGestureIconOnHand(ctx, x, y, gesture) {
            const gestureDataItem = gestureData[gesture] || gestureData.unknown;
            
            // 繪製圓形背景
            ctx.beginPath();
            ctx.arc(x, y, 35, 0, Math.PI * 2);
            ctx.fillStyle = 'rgba(0, 20, 60, 0.8)';
            ctx.fill();
            
            // 繪製邊框
            ctx.beginPath();
            ctx.arc(x, y, 35, 0, Math.PI * 2);
            ctx.strokeStyle = gestureDataItem.color;
            ctx.lineWidth = 3;
            ctx.stroke();
            
            // 繪製圖標（文字形式）
            ctx.save();
            ctx.translate(x, y);
            
            ctx.font = 'bold 24px Arial';
            ctx.fillStyle = gestureDataItem.color;
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            
            let iconText = '?';
            if (gesture === 'rock') iconText = '✊';
            else if (gesture === 'paper') iconText = '✋';
            else if (gesture === 'scissors') iconText = '✌️';
            
            ctx.fillText(iconText, 0, 0);
            
            ctx.restore();
        }
        
        // 改良版手勢辨識（特別加強剪刀偵測）
        function recognizeGestureImproved(landmarks) {
            const thumbTip = landmarks[4];
            const indexTip = landmarks[8];
            const middleTip = landmarks[12];
            const ringTip = landmarks[16];
            const pinkyTip = landmarks[20];
            const wrist = landmarks[0];
            
            // 計算各手指到手腕的距離
            const distances = {
                thumb: distance2D(thumbTip, wrist),
                index: distance2D(indexTip, wrist),
                middle: distance2D(middleTip, wrist),
                ring: distance2D(ringTip, wrist),
                pinky: distance2D(pinkyTip, wrist)
            };
            
            // 計算手指伸直程度
            const indexMCP = landmarks[5];
            const middleMCP = landmarks[9];
            const ringMCP = landmarks[13];
            const pinkyMCP = landmarks[17];
            
            const straightness = {
                index: distance2D(indexTip, indexMCP) / distance2D(indexMCP, wrist),
                middle: distance2D(middleTip, middleMCP) / distance2D(middleMCP, wrist),
                ring: distance2D(ringTip, ringMCP) / distance2D(ringMCP, wrist),
                pinky: distance2D(pinkyTip, pinkyMCP) / distance2D(pinkyMCP, wrist)
            };
            
            // 計算手指間距（特別針對剪刀）
            const indexMiddleDist = distance2D(indexTip, middleTip);
            const middleRingDist = distance2D(middleTip, ringTip);
            
            // 計算平均距離（排除拇指）
            const fingerDistances = [distances.index, distances.middle, distances.ring, distances.pinky];
            const avgDistance = fingerDistances.reduce((a, b) => a + b) / fingerDistances.length;
            
            // 剪刀手勢檢測（加強版）
            // 條件：食指和中指伸直且分開，無名指和小指彎曲
            const isScissors = 
                distances.index > 0.25 &&
                distances.middle > 0.25 &&
                distances.ring < 0.2 &&
                distances.pinky < 0.2 &&
                straightness.index > 1.2 &&
                straightness.middle > 1.2 &&
                straightness.ring < 0.9 &&
                straightness.pinky < 0.9 &&
                indexMiddleDist > 0.08; // 食指和中指要分開
            
            // 石頭手勢檢測
            const isRock = 
                avgDistance < 0.18 &&
                straightness.index < 0.8 &&
                straightness.middle < 0.8 &&
                straightness.ring < 0.8 &&
                straightness.pinky < 0.8;
            
            // 布手勢檢測
            const isPaper = 
                avgDistance > 0.22 &&
                straightness.index > 1.0 &&
                straightness.middle > 1.0 &&
                straightness.ring > 0.9 &&
                straightness.pinky > 0.9;
            
            // 優先偵測剪刀，因為最難偵測
            if (isScissors) return 'scissors';
            if (isRock) return 'rock';
            if (isPaper) return 'paper';
            
            return 'unknown';
        }
        
        // 計算信心度
        function calculateConfidenceImproved(landmarks, gesture) {
            let confidence = 0.5; // 基礎信心度
            
            // 檢查關鍵點可見性
            let visiblePoints = 0;
            const importantPoints = [0, 4, 8, 12, 16, 20];
            importantPoints.forEach(index => {
                if (landmarks[index].visibility > 0.5) {
                    visiblePoints++;
                }
            });
            confidence += (visiblePoints / importantPoints.length) * 0.3;
            
            // 根據手勢類型調整信心度
            if (gesture === 'scissors') {
                const indexTip = landmarks[8];
                const middleTip = landmarks[12];
                const ringTip = landmarks[16];
                const wrist = landmarks[0];
                
                // 檢查剪刀手勢的特徵
                const indexDist = distance2D(indexTip, wrist);
                const middleDist = distance2D(middleTip, wrist);
                const ringDist = distance2D(ringTip, wrist);
                const indexMiddleDist = distance2D(indexTip, middleTip);
                
                // 食指和中指要伸直且分開
                if (indexDist > 0.25 && middleDist > 0.25 && indexMiddleDist > 0.08) {
                    confidence += 0.2;
                }
                
                // 無名指要彎曲
                if (ringDist < 0.2) {
                    confidence += 0.1;
                }
            }
            
            return Math.min(confidence, 1.0);
        }
        
        // 計算2D距離
        function distance2D(point1, point2) {
            const dx = point1.x - point2.x;
            const dy = point1.y - point2.y;
            return Math.sqrt(dx * dx + dy * dy);
        }
        
        // 開始倒數
        function startCountdown() {
            isCountdownActive = true;
            countdownValue = 3;
            
            // 創建倒數顯示元素
            const countdownElement = document.createElement('div');
            countdownElement.className = 'countdown';
            countdownElement.id = 'countdown-display';
            countdownElement.textContent = countdownValue;
            document.getElementById('camera-container').appendChild(countdownElement);
            
            // 倒數計時器
            const countdownInterval = setInterval(() => {
                countdownValue--;
                
                if (countdownValue > 0) {
                    countdownElement.textContent = countdownValue;
                    countdownElement.classList.add('pulse');
                    setTimeout(() => countdownElement.classList.remove('pulse'), 500);
                } else {
                    countdownElement.textContent = '出招！';
                    countdownElement.style.color = '#7AFF8E';
                    
                    setTimeout(() => {
                        clearInterval(countdownInterval);
                        document.getElementById('camera-container').removeChild(countdownElement);
                        isCountdownActive = false;
                        playGame();
                    }, 500);
                }
            }, 1000);
        }
        
        // 電腦隨機選擇
        function getComputerChoice() {
            const choices = ['rock', 'paper', 'scissors'];
            const randomIndex = Math.floor(Math.random() * 3);
            return choices[randomIndex];
        }
        
        // 決定勝負
        function determineWinner(player, computer) {
            if (player === computer) return 'draw';
            
            if (
                (player === 'rock' && computer === 'scissors') ||
                (player === 'paper' && computer === 'rock') ||
                (player === 'scissors' && computer === 'paper')
            ) {
                return 'player';
            }
            
            return 'computer';
        }
        
        // 播放遊戲
        function playGame() {
            if (!isCameraOn || currentGesture === 'unknown') {
                gameInfoElement.textContent = '請開啟鏡頭並顯示正確手勢！';
                resultTextElement.classList.add('shake');
                setTimeout(() => {
                    resultTextElement.classList.remove('shake');
                }, 500);
                return;
            }
            
            // 電腦選擇
            const computerChoice = getComputerChoice();
            
            // 決定勝負
            const winner = determineWinner(currentGesture, computerChoice);
            
            // 更新分數和統計
            totalGames++;
            
            let resultText = '';
            let resultClass = '';
            
            if (winner === 'player') {
                playerScore++;
                playerWins++;
                winStreak++;
                maxWinStreak = Math.max(maxWinStreak, winStreak);
                resultText = '你贏了！';
                resultClass = 'win';
                gameInfoElement.textContent = `${gestureData[currentGesture].text} 贏 ${gestureData[computerChoice].text}`;
            } else if (winner === 'computer') {
                computerScore++;
                winStreak = 0;
                resultText = '電腦贏了！';
                resultClass = 'lose';
                gameInfoElement.textContent = `${gestureData[computerChoice].text} 贏 ${gestureData[currentGesture].text}`;
            } else {
                resultText = '平手！';
                resultClass = 'draw';
                gameInfoElement.textContent = '雙方選擇相同';
            }
            
            // 更新結果顯示
            resultTextElement.textContent = resultText;
            resultTextElement.className = resultClass;
            
            // 更新統計數據
            updateUI();
            
            // 添加動畫效果
            resultTextElement.classList.add('pulse');
            setTimeout(() => {
                resultTextElement.classList.remove('pulse');
            }, 1000);
            
            // 重置遊戲狀態
            isGameActive = false;
            playButton.innerHTML = '<i class="fas fa-fist-raised"></i> 開始遊戲';
            gestureStableTime = 0;
            gestureStableCount = 0;
            
            // 3秒後恢復提示
            setTimeout(() => {
                if (!isGameActive) {
                    gameInfoElement.textContent = '將手掌放入中央圓圈，保持手勢2秒';
                }
            }, 3000);
        }
        
        // 開始鏡頭
        async function startCamera() {
            try {
                permissionMessage.style.display = 'none';
                cameraError.style.display = 'none';
                
                // 請求鏡頭權限
                const stream = await navigator.mediaDevices.getUserMedia({
                    video: {
                        width: { ideal: 640 },
                        height: { ideal: 480 },
                        facingMode: 'user',
                        frameRate: { ideal: 30 }
                    },
                    audio: false
                });
                
                // 設定影像來源
                cameraFeed.srcObject = stream;
                isCameraOn = true;
                
                // 初始化手勢辨識
                if (!handsModel) {
                    initHandDetection();
                }
                
                // 開始處理影像
                const camera = new Camera(cameraFeed, {
                    onFrame: async () => {
                        if (isCameraOn) {
                            await handsModel.send({image: cameraFeed});
                        }
                    },
                    width: 640,
                    height: 480
                });
                
                camera.start();
                
                // 更新UI
                startCameraBtn.disabled = true;
                stopCameraBtn.disabled = false;
                playButton.disabled = false;
                
                gameInfoElement.textContent = '鏡頭已開啟，請將手掌放入中央圓圈';
                
            } catch (error) {
                console.error('無法存取鏡頭:', error);
                cameraError.style.display = 'flex';
                errorMessage.textContent = `錯誤: ${error.message}`;
                isCameraOn = false;
            }
        }
        
        // 停止鏡頭
        function stopCamera() {
            if (cameraFeed.srcObject) {
                const tracks = cameraFeed.srcObject.getTracks();
                tracks.forEach(track => track.stop());
                cameraFeed.srcObject = null;
            }
            
            isCameraOn = false;
            isGameActive = false;
            isCountdownActive = false;
            
            // 移除倒數顯示
            const countdownElement = document.getElementById('countdown-display');
            if (countdownElement) {
                countdownElement.remove();
            }
            
            // 更新UI
            startCameraBtn.disabled = false;
            stopCameraBtn.disabled = true;
            playButton.disabled = true;
            playButton.innerHTML = '<i class="fas fa-fist-raised"></i> 開始遊戲';
            
            // 清空canvas
            const canvasCtx = cameraOverlay.getContext('2d');
            canvasCtx.clearRect(0, 0, cameraOverlay.width, cameraOverlay.height);
            
            // 重置狀態
            handDetected = false;
            currentGesture = 'unknown';
            gestureStableTime = 0;
            gestureStableCount = 0;
            updateHandDisplay();
            updateGestureDisplay();
            
            gameInfoElement.textContent = '鏡頭已關閉';
            gestureStatus.textContent = '等待手部...';
            gestureHelp.textContent = '請將手掌放入圓圈中';
        }
        
        // 重置遊戲
        function resetGame() {
            initGame();
            
            // 顯示重置訊息
            resultTextElement.textContent = '遊戲已重置！';
            resultTextElement.className = 'draw';
            gameInfoElement.textContent = '請開啟鏡頭開始遊戲';
            
            // 添加動畫效果
            resultTextElement.classList.add('glow');
            setTimeout(() => {
                resultTextElement.classList.remove('glow');
            }, 2000);
        }
        
        // 事件監聽器
        startCameraBtn.addEventListener('click', startCamera);
        stopCameraBtn.addEventListener('click', stopCamera);
        
        playButton.addEventListener('click', () => {
            if (!isCameraOn) {
                gameInfoElement.textContent = '請先開啟鏡頭！';
                resultTextElement.classList.add('shake');
                setTimeout(() => {
                    resultTextElement.classList.remove('shake');
                }, 500);
                return;
            }
            
            if (!isGameActive) {
                isGameActive = true;
                playButton.innerHTML = '<i class="fas fa-hourglass-half"></i> 準備中...';
                gameInfoElement.textContent = '請將手掌放入圓圈，保持手勢2秒';
                resultTextElement.textContent = '準備遊戲...';
                resultTextElement.className = '';
            }
        });
        
        resetButton.addEventListener('click', resetGame);
        
        requestPermissionBtn.addEventListener('click', startCamera);
        retryCameraBtn.addEventListener('click', startCamera);
        
        // 初始化
        function init() {
            // 初始設定
            stopCameraBtn.disabled = true;
            playButton.disabled = true;
            
            // 檢查瀏覽器是否支援
            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                permissionMessage.style.display = 'none';
                cameraError.style.display = 'flex';
                errorMessage.textContent = '您的瀏覽器不支援鏡頭功能，請使用最新版的Chrome、Edge或Firefox瀏覽器。';
            }
            
            // 初始化遊戲
            initGame();
        }
        
        // 頁面載入時初始化
        window.addEventListener('DOMContentLoaded', init);
        
        // 鍵盤控制
        document.addEventListener('keydown', (event) => {
            switch(event.key) {
                case ' ':
                case 'Enter':
                    if (isCameraOn && !isGameActive) {
                        playButton.click();
                    }
                    break;
                case 'Escape':
                    resetButton.click();
                    break;
                case '1':
                    if (!isCameraOn) {
                        startCameraBtn.click();
                    }
                    break;
                case '2':
                    if (isCameraOn) {
                        stopCameraBtn.click();
                    }
                    break;
            }
        });
    </script>
</body>
</html>